I"`›<h2 id="http-ì¸ì¦-ì´ë€">HTTP ì¸ì¦ ì´ë€?</h2>

<p>Authentication(ì¸ì¦) ì´ë€ ì‹œìŠ¤í…œì´ ì‚¬ìš©ìê°€ ì‹œìŠ¤í…œì— ì ‘ê·¼ ê°€ëŠ¥í•œ í—ˆìš©ì„ ê°€ì§€ê³  ìˆëŠ”ì§€ ì—†ëŠ”ì§€ ê²°ì •í•˜ëŠ” í”„ë¡œì„¸ìŠ¤ì´ë‹¤. HTTPëŠ” ì•¡ì„¸ìŠ¤ ì œì–´ì™€ ì¸ì¦ì„ ìœ„í•œ í”„ë ˆì„ì›Œí¬ë¥¼ ì œê³µí•œë‹¤.</p>

<h2 id="http-ì¸ì¦-ì¢…ë¥˜">HTTP ì¸ì¦ ì¢…ë¥˜</h2>

<ul>
  <li>BASIC : ê°€ì¥ ì¼ë°˜ì ì¸ ì´ì¦ ë°©ì‹</li>
  <li>Digest</li>
  <li>Oauth</li>
  <li>Token-based</li>
</ul>

<h2 id="basic-authentication">Basic Authentication</h2>

<p>ì„œë²„ê°€ ì§€ì •ëœ ì˜ì—­ì— ì¸ì¦ì´ í•„ìš”í•˜ë‹¤ëŠ” ê²ƒì„ í—¤ë”ì— ë‹´ì•„ì„œ ë‹¤ì‹œ ë³´ë‚¸ë‹¤. ì‚¬ìš©ìëŠ” ë¸Œë¼ìš°ì €ê°€ ì—°ê²° í•œ ì•„ì´ë””ì™€ íŒ¨ìŠ¤ì›Œë“œ (username + â€œ:â€ +password)ì™€ base62 ì¸ì½”ë“œë¥¼ ì œê³µí•œë‹¤. ì•”í˜¸í™”ëœ Stringì€ Authorization í—¤ë”ì— ë‹´ì•„ì„œ ë¸Œë¼ìš°ì €ì—ì„œ ê° ìš”ì²­ ë§ˆë‹¤ ë³´ë‚´ì§„ë‹¤.</p>

<p>ìƒëŒ€ì ìœ¼ë¡œ ê°„ë‹¨í•œ í”„ë¡œí† ì½œì´ê³  ëª¨ë“  ì£¼ ë¸Œë¼ìš°ì €ì—ì„œ ì§€ì›í•œë‹¤. ê·¸ëŸ¬ë‚˜ ì´ ì¸ì¦ì„ ì‚¬ì˜¹í•˜ë©´ ëª‡ê°€ì§€ ë‹¨ì ì´ ìˆë‹¤.</p>

<ul>
  <li>ì‚¬ìš©ì Credentials ë¥¼ ìš”ì²­ì— ë³´ë‚¸ë‹¤.</li>
  <li>CredentailsëŠ” í”Œë ˆì¸ í…ìŠ¤íŠ¸ì´ë‹¤.</li>
  <li>ë§¤ ìš”ì²­ì— Credentialsì„ ë³´ë‚¸ë‹¤.</li>
  <li>ë¸Œë¼ìš°ì¦ˆ ì„¸ì…˜ì„ ì¢…ë£Œí•˜ëŠ”ê±° ë§ê³ ëŠ” ë¡œê·¸ì•„ì›ƒ ë°©ë²•ì´ ì—†ë‹¤.</li>
  <li>cross-site request forgery (CSRF)ì— ì·¨ì•½í•˜ë‹¤.</li>
</ul>

<p><img src="https://eunmik.github.io/bonita.github.io/assets/img/2021/0708/img1.png" /></p>

<h2 id="digest-authentication">Digest Authentication</h2>

<p>DigestëŠ” ì•”í˜¸í™” ë˜ì§€ ì•Šì€ HTTP ê¸°ë³¸ access ì¸ì¦ì„ ëŒ€ì²´í•˜ë ¤ê³  í•˜ì§€ë§Œ public-keyë‚˜ Kerberos ì¸ì¦ ê°™ì´ ê°•í•œ ì¸ì¦ í”„ë¡œí† ì½œì„ ëŒ€ì²´í•˜ì§€ëŠ” ì•ŠëŠ”ë‹¤.</p>

<p>DigestëŠ” ì‚¬ìš©ìì˜ requestë¥¼ ë„¤íŠ¸ì›Œí¬ ì„œë²„ì—ì„œ ë°›ì€ ë‹¤ìŒì— domain controllerë¡œ ì „ì†¡í•˜ëŠ” ì¸ì¦ ë°©ì‹ì´ë‹¤.</p>

<p>Domain ControllerëŠ” digest session keyë¼ëŠ” íŠ¹ë³„í•œ keyë¥¼ ì²˜ìŒ ìš”ì²­ì„ ë°›ì€ ì„œë²„ì— ë³´ë‚¸ë‹¤.</p>

<p>ì‚¬ìš©ìëŠ” ê·¸ë¦¬ê³  ì•”í˜¸í™”ëœ Responseë¥¼ ì„œë²„ì— ë³´ë‚¸ë‹¤. ë§Œì•½ ì‚¬ìš©ìì˜ responseê°€ ì˜¬ë°”ë¥¸ í˜•ì‹ì´ë¼ë©´ ì„œë²„ëŠ” ì‚¬ìš©ìê°€ ì ‘ê·¼ì„ í•˜ë„ë¡ í—ˆìš©í•œë‹¤.</p>

<p>ê·¸ëŸ¬ë‚˜ ì´ ì¸ì¦ì˜ ë‹¨ì ì€ digest access authenticationì€ í´ë¼ì´ì–¸íŠ¸ê°€ ì„œë²„ì˜ ì•„ì´ë´í‹°í‹°ë¥¼ ì¦ë©¸í•  ìˆ˜ ìˆëŠ” ë©”ì»¤ë‹ˆì¦˜ì„ ì œê³µí•˜ì§€ ì•ŠëŠ”ë‹¤.</p>

<h2 id="oauth-authentication">OAuth Authentication</h2>

<p>OAuth (Open Authentication/Authorization) ëŠ” ì¸ì¦ì„ ìœ„í•œ í‘œì¤€ í”„ë¡œí† ì½œì´ë‹¤. êµ¬ê¸€, í˜ì´ìŠ¤ë¶, ì¹´ì¹´ì˜¤ ë“±ì—ì„œ ì œê³µí•˜ëŠ” Authorization Serverë¥¼ í†µí•´ íšŒì› ì •ë³´ë¥¼ ì¸ì¦í•˜ê³  Access Tokenì„ ë°œê¸‰ ë°›ëŠ”ë‹¤.  ë¹„ë°€ë²ˆí˜¸(credentials)ë¥¼ ì‚¬ìš©í•˜ì§€ ì•Šê³  í•œ ì‚¬ì´íŠ¸ì— ì €ì¥ëœ ë¦¬ì†ŒìŠ¤ë¥¼ ë‹¤ë¥¸ ì‚¬ì´íŠ¸ì—ì„œ ì‚¬ìš©í•˜ë„ë¡ í—ˆìš©í•œë‹¤.</p>

<h2 id="token-based-authentication">Token Based Authentication</h2>

<p>í† í° ê¸°ë°˜ ì¸ì¦ì€ ì¸ì¦í•  ë•Œ access tokenì„ ë°œí–‰í•œë‹¤. ì´ í† í°ì€ ì‚¬ìš©ë˜ëŠ” ì—ì½”ì‹œìŠ¤í…œì— ë”°ë¼ ë‹¤ì–‘í•œ í˜•íƒœë¡œ ì‚¬ìš©ë  ìˆ˜ ìˆë‹¤. í´ë¼ì´ì–¸íŠ¸ëŠ” ì‚¬ìš©ìì•„ì´ë””ì™€ íŒ¨ìŠ¤ì›Œë“œë¥¼ access tokenì„ ì–»ê¸° ìœ„í•´ ì…ë ¥ í•  ìˆ˜ ìˆë‹¤. í´ë¼ì´ì–¸íŠ¸ê°€ ì´ í† í°ì„ ê°–ê³  ìˆê³  ë§¤ ìš”ì²­ë§ˆë‹¤ ì„œë²„ì— ë³´ë‚¸ë‹¤. í´ë¼ì´ì–¸íŠ¸ê°€ ë³´ë‚¸ ë§¤ ìš”ì²­ì´ ì§„í–‰ë˜ëŠ” ë™ì•ˆ, ì„œë²„ëŠ” HTTPëŠ” statelessì´ê¸° ë•Œë¬¸ì— í´ë¼ì´ì–¸íŠ¸ê°€ ì´ë¯¸ ì¸ì¦ì´ ë˜ì—ˆëŠ”ì§€ ì•Œì§€ ëª»í•œë‹¤. ê·¸ë˜ì„œ ê·¸ í† í°ì„ í†µí•´ í´ë¼ì´ì–¸íŠ¸ê°€ ì¸ì¦ì´ ë˜ì—ˆëŠ”ì§€ í™•ì¸í•œë‹¤. ê·¸ë¦¬ê³ ë‚˜ì„œ ìš”ì²­ëœ ìì›ì— ì ‘ê·¼ì„ ì œê³µí•œë‹¤.</p>

<p><img src="https://eunmik.github.io/bonita.github.io/assets/img/2021/0708/img2.png" /></p>

<h2 id="digest-ì¸ì¦-êµ¬í˜„í•˜ê¸°">Digest ì¸ì¦ êµ¬í˜„í•˜ê¸°</h2>

<h3 id="clientìª½-http-authentication-êµ¬í˜„">Clientìª½ Http Authentication êµ¬í˜„</h3>

<h3 id="basic-authentication-1">Basic Authentication</h3>

<p>CustomBasicAuthWebSecurityConfig.java</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">org.springframework.context.annotation.Bean</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.annotation.Configuration</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.config.annotation.authentication.builders.AuthenticationManagerBuilder</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.config.annotation.web.builders.HttpSecurity</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.config.annotation.web.configuration.WebSecurityConfigurerAdapter</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.crypto.password.NoOpPasswordEncoder</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.crypto.password.PasswordEncoder</span><span class="o">;</span>

<span class="nd">@Configuration</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">CustomBasicAuthWebSecurityConfig</span> <span class="kd">extends</span> <span class="nc">WebSecurityConfigurerAdapter</span>
 <span class="o">{</span>

    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">configure</span><span class="o">(</span><span class="nc">AuthenticationManagerBuilder</span> <span class="n">auth</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
        <span class="n">auth</span><span class="o">.</span><span class="na">inMemoryAuthentication</span><span class="o">()</span>
                <span class="o">.</span><span class="na">withUser</span><span class="o">(</span><span class="s">"username"</span><span class="o">)</span>
                <span class="o">.</span><span class="na">password</span><span class="o">(</span><span class="n">passwordEncoder</span><span class="o">().</span><span class="na">encode</span><span class="o">(</span><span class="s">"password"</span><span class="o">))</span>
                <span class="o">.</span><span class="na">roles</span><span class="o">(</span><span class="s">"USER"</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="nc">PasswordEncoder</span> <span class="nf">passwordEncoder</span><span class="o">()</span> <span class="o">{</span>
        <span class="c1">//return new BCryptPasswordEncoder();</span>
        <span class="k">return</span> <span class="nc">NoOpPasswordEncoder</span><span class="o">.</span><span class="na">getInstance</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">configure</span><span class="o">(</span><span class="nc">HttpSecurity</span> <span class="n">http</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>

        <span class="n">http</span> <span class="o">.</span><span class="na">antMatcher</span><span class="o">(</span><span class="s">"/**"</span><span class="o">)</span>
                <span class="o">.</span><span class="na">authorizeRequests</span><span class="o">()</span>
                <span class="o">.</span><span class="na">anyRequest</span><span class="o">().</span><span class="na">authenticated</span><span class="o">()</span>
                <span class="c1">// httpBasic authentication</span>
                <span class="o">.</span><span class="na">and</span><span class="o">()</span> <span class="o">.</span><span class="na">csrf</span><span class="o">().</span><span class="na">disable</span><span class="o">().</span><span class="na">httpBasic</span><span class="o">();</span>
    <span class="o">}</span>

<span class="o">}</span>
</code></pre></div></div>

<h3 id="digest-authentication-1">Digest Authentication</h3>

<p>CustomDigestAuthWebSecurityConfig.java</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">org.springframework.context.annotation.Bean</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.annotation.Configuration</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.core.annotation.Order</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.config.annotation.authentication.builders.AuthenticationManagerBuilder</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.config.annotation.method.configuration.EnableGlobalMethodSecurity</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.config.annotation.web.builders.HttpSecurity</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.config.annotation.web.configuration.WebSecurityConfigurerAdapter</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.core.userdetails.UserDetailsService</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.crypto.password.NoOpPasswordEncoder</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.crypto.password.PasswordEncoder</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.web.authentication.www.DigestAuthenticationEntryPoint</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.web.authentication.www.DigestAuthenticationFilter</span><span class="o">;</span>

<span class="nd">@Configuration</span>
<span class="nd">@EnableGlobalMethodSecurity</span><span class="o">(</span><span class="n">prePostEnabled</span> <span class="o">=</span> <span class="kc">true</span><span class="o">,</span> <span class="n">securedEnabled</span> <span class="o">=</span> <span class="kc">true</span><span class="o">,</span> <span class="n">jsr250Enabled</span> <span class="o">=</span> <span class="kc">true</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">CustomDigestAuthWebSecurityConfig</span><span class="c1">//extends WebSecurityConfigurerAdapter</span>
<span class="o">{</span>

    <span class="nd">@Configuration</span>
    <span class="nd">@Order</span><span class="o">(</span><span class="mi">1</span><span class="o">)</span>
    <span class="kd">public</span> <span class="kd">class</span> <span class="nc">AdminSecurityConfiguration</span> <span class="kd">extends</span> <span class="nc">WebSecurityConfigurerAdapter</span>
    <span class="o">{</span>
        <span class="c1">// Configure DigestAuthenticationEntryPoint</span>
        <span class="kd">private</span> <span class="nc">DigestAuthenticationEntryPoint</span> <span class="nf">getDigestEntryPoint</span><span class="o">()</span> <span class="o">{</span>
            <span class="nc">DigestAuthenticationEntryPoint</span> <span class="n">digestEntryPoint</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">DigestAuthenticationEntryPoint</span><span class="o">();</span>
            <span class="n">digestEntryPoint</span><span class="o">.</span><span class="na">setRealmName</span><span class="o">(</span><span class="s">"admin"</span><span class="o">);</span>
            <span class="n">digestEntryPoint</span><span class="o">.</span><span class="na">setKey</span><span class="o">(</span><span class="s">"somedigestkey"</span><span class="o">);</span>
            <span class="k">return</span> <span class="n">digestEntryPoint</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="c1">// PasswordEncoder Bean</span>
        <span class="nd">@Bean</span>
        <span class="kd">public</span> <span class="nc">PasswordEncoder</span> <span class="nf">passwordEncoder</span><span class="o">()</span> <span class="o">{</span>
            <span class="c1">//return new BCryptPasswordEncoder();</span>

            <span class="k">return</span> <span class="nc">NoOpPasswordEncoder</span><span class="o">.</span><span class="na">getInstance</span><span class="o">();</span>
        <span class="o">}</span>

        <span class="c1">//Configure authentication manager</span>

        <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">configure</span><span class="o">(</span><span class="nc">AuthenticationManagerBuilder</span> <span class="n">auth</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
            <span class="n">auth</span><span class="o">.</span><span class="na">inMemoryAuthentication</span><span class="o">()</span>
                    <span class="o">.</span><span class="na">withUser</span><span class="o">(</span><span class="s">"username"</span><span class="o">)</span>
                    <span class="o">.</span><span class="na">password</span><span class="o">(</span><span class="n">passwordEncoder</span><span class="o">().</span><span class="na">encode</span><span class="o">(</span><span class="s">"password"</span><span class="o">))</span>
                    <span class="o">.</span><span class="na">roles</span><span class="o">(</span><span class="s">"USER"</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="c1">//default UserDetailsService configured by  UserDetailsServiceAutoConfiguration</span>

        <span class="nd">@Bean</span>
        <span class="kd">public</span> <span class="nc">UserDetailsService</span> <span class="nf">userDetailsServiceBean</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kd">super</span><span class="o">.</span><span class="na">userDetailsServiceBean</span><span class="o">();</span>
        <span class="o">}</span>

        <span class="c1">// Configure  DigestAuthenticationFilter.</span>
        <span class="c1">// Notice the we are injecting userDetailsService and DigestAuthenticationEntryPoint</span>

        <span class="kd">private</span> <span class="nc">DigestAuthenticationFilter</span> <span class="nf">getDigestAuthFilter</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
            <span class="nc">DigestAuthenticationFilter</span> <span class="n">digestFilter</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">DigestAuthenticationFilter</span><span class="o">();</span>

            <span class="n">digestFilter</span><span class="o">.</span><span class="na">setUserDetailsService</span><span class="o">(</span><span class="n">userDetailsServiceBean</span><span class="o">());</span>

            <span class="n">digestFilter</span><span class="o">.</span><span class="na">setAuthenticationEntryPoint</span><span class="o">(</span><span class="n">getDigestEntryPoint</span><span class="o">());</span>
            <span class="k">return</span> <span class="n">digestFilter</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="c1">//Notice that we are configuring / admin/ * * for the SecurityFilterChain</span>
        <span class="c1">// added DigestAuthenticationFilter, also configured the EntryPoint authentication.</span>

        <span class="nd">@Override</span>
        <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">configure</span><span class="o">(</span><span class="nc">HttpSecurity</span> <span class="n">http</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
            <span class="n">http</span><span class="o">.</span><span class="na">antMatcher</span><span class="o">(</span><span class="s">"/**"</span><span class="o">).</span>
                    <span class="n">addFilter</span><span class="o">(</span><span class="n">getDigestAuthFilter</span><span class="o">()).</span><span class="na">exceptionHandling</span><span class="o">()</span>
                    <span class="o">.</span><span class="na">authenticationEntryPoint</span><span class="o">(</span><span class="n">getDigestEntryPoint</span><span class="o">())</span>
                    <span class="o">.</span><span class="na">and</span><span class="o">().</span><span class="na">csrf</span><span class="o">().</span><span class="na">disable</span><span class="o">().</span><span class="na">authorizeRequests</span><span class="o">().</span><span class="na">antMatchers</span><span class="o">(</span><span class="s">"/**"</span><span class="o">).</span><span class="na">hasRole</span><span class="o">(</span><span class="s">"USER"</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<h2 id="serverìª½-http-ì¸ì¦-ìš”ì²­-êµ¬í˜„">Serverìª½ Http ì¸ì¦ ìš”ì²­ êµ¬í˜„</h2>

<p>HttpRequestFactoryAuthentication.java</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">com.argos_labs.rpa.la.report.api.model.AuthType</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">lombok.RequiredArgsConstructor</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.http.HttpHost</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.http.auth.AuthScheme</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.http.auth.AuthScope</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.http.auth.UsernamePasswordCredentials</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.http.client.AuthCache</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.http.client.CookieStore</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.http.client.CredentialsProvider</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.http.client.protocol.HttpClientContext</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.http.impl.auth.BasicScheme</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.http.impl.auth.DigestScheme</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.http.impl.client.BasicAuthCache</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.http.impl.client.BasicCookieStore</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.http.impl.client.BasicCredentialsProvider</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.http.impl.client.HttpClients</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.http.impl.cookie.BasicClientCookie</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.http.protocol.BasicHttpContext</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.http.protocol.HttpContext</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.http.HttpMethod</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.http.client.HttpComponentsClientHttpRequestFactory</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.net.URI</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.security.SecureRandom</span><span class="o">;</span>

<span class="nd">@RequiredArgsConstructor</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">HttpRequestFactoryAuthentication</span> <span class="kd">extends</span> <span class="nc">HttpComponentsClientHttpRequestFactory</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">BasicHttpContext</span> <span class="n">context</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">AuthCache</span> <span class="n">cache</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">CredentialsProvider</span> <span class="n">credentialsProvider</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">HttpRequestFactoryAuthentication</span><span class="o">(){</span>
        <span class="kd">super</span><span class="o">();</span>
        <span class="n">context</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">BasicHttpContext</span><span class="o">();</span>
        <span class="n">cache</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">BasicAuthCache</span><span class="o">();</span>
        <span class="n">credentialsProvider</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">BasicCredentialsProvider</span><span class="o">();</span>

        <span class="n">context</span><span class="o">.</span><span class="na">setAttribute</span><span class="o">(</span><span class="nc">HttpClientContext</span><span class="o">.</span><span class="na">AUTH_CACHE</span><span class="o">,</span> <span class="n">cache</span><span class="o">);</span>

    <span class="o">}</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setCredentials</span><span class="o">(</span><span class="nc">HttpHost</span> <span class="n">host</span><span class="o">,</span> <span class="nc">String</span> <span class="n">authType</span><span class="o">,</span> <span class="nc">String</span> <span class="n">username</span><span class="o">,</span> <span class="nc">String</span> <span class="n">password</span><span class="o">){</span>

        <span class="c1">//AuthScheme scheme = null;</span>
        <span class="k">if</span><span class="o">(</span><span class="n">authType</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="nc">AuthType</span><span class="o">.</span><span class="na">BasicType</span><span class="o">.</span><span class="na">value</span><span class="o">())){</span>
            <span class="nc">AuthScheme</span> <span class="n">scheme</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">BasicScheme</span><span class="o">();</span>
            <span class="n">cache</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">host</span><span class="o">,</span> <span class="n">scheme</span><span class="o">);</span>
        <span class="o">}</span><span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">authType</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="nc">AuthType</span><span class="o">.</span><span class="na">DigestType</span><span class="o">.</span><span class="na">value</span><span class="o">())){</span>
            <span class="nc">DigestScheme</span> <span class="n">scheme</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">DigestScheme</span><span class="o">();</span>
            <span class="n">scheme</span><span class="o">.</span><span class="na">overrideParamter</span><span class="o">(</span><span class="s">"realm"</span><span class="o">,</span><span class="s">"admin"</span><span class="o">);</span>
            <span class="c1">//String nonce = Long.toString(new SecureRandom().nextLong(), 36);</span>
            <span class="c1">//scheme.overrideParamter("nonce", nonce);</span>
            <span class="n">cache</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">host</span><span class="o">,</span> <span class="n">scheme</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="nc">UsernamePasswordCredentials</span> <span class="n">credentials</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">UsernamePasswordCredentials</span><span class="o">(</span><span class="n">username</span><span class="o">,</span> <span class="n">password</span><span class="o">);</span>
        <span class="n">credentialsProvider</span><span class="o">.</span><span class="na">setCredentials</span><span class="o">(</span><span class="k">new</span> <span class="nc">AuthScope</span><span class="o">(</span><span class="n">host</span><span class="o">),</span> <span class="n">credentials</span><span class="o">);</span>

        <span class="nc">CookieStore</span> <span class="n">cookieStore</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">BasicCookieStore</span><span class="o">();</span>
        <span class="nc">BasicClientCookie</span> <span class="n">cookie</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">BasicClientCookie</span><span class="o">(</span><span class="s">"cookie"</span><span class="o">,</span><span class="s">"value"</span><span class="o">);</span>
        <span class="n">cookie</span><span class="o">.</span><span class="na">setDomain</span><span class="o">(</span><span class="n">host</span><span class="o">.</span><span class="na">getHostName</span><span class="o">());</span>
        <span class="n">cookie</span><span class="o">.</span><span class="na">setPath</span><span class="o">(</span><span class="s">"/"</span><span class="o">);</span>
        <span class="n">cookieStore</span><span class="o">.</span><span class="na">addCookie</span><span class="o">(</span><span class="n">cookie</span><span class="o">);</span>

        <span class="n">setHttpClient</span><span class="o">(</span><span class="nc">HttpClients</span><span class="o">.</span><span class="na">custom</span><span class="o">().</span><span class="na">setDefaultCookieStore</span><span class="o">(</span><span class="n">cookieStore</span><span class="o">).</span><span class="na">setDefaultCredentialsProvider</span><span class="o">(</span><span class="n">credentialsProvider</span><span class="o">).</span><span class="na">build</span><span class="o">());</span>
    <span class="o">}</span>
    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="nc">HttpContext</span> <span class="nf">createHttpContext</span><span class="o">(</span><span class="nc">HttpMethod</span> <span class="n">httpMethod</span><span class="o">,</span> <span class="no">URI</span> <span class="n">uri</span><span class="o">){</span>
        <span class="k">return</span> <span class="n">context</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="nc">HttpClientContext</span> <span class="nf">createHttpClientContext</span><span class="o">(){</span>
        <span class="nc">HttpClientContext</span> <span class="n">context</span> <span class="o">=</span> <span class="nc">HttpClientContext</span><span class="o">.</span><span class="na">create</span><span class="o">();</span>
        <span class="n">context</span><span class="o">.</span><span class="na">setCredentialsProvider</span><span class="o">(</span><span class="n">credentialsProvider</span><span class="o">);</span>
        <span class="n">context</span><span class="o">.</span><span class="na">setAuthCache</span><span class="o">(</span><span class="n">cache</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">context</span><span class="o">;</span>

    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>HttpAuth</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="nc">Response</span> <span class="nf">httpAuth</span><span class="o">(</span><span class="nc">PamStatus</span> <span class="n">pamStatus</span><span class="o">,</span> <span class="nc">OpenapiEndpointInfo</span> <span class="n">openapiEndpointInfo</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="nc">String</span><span class="o">[]</span> <span class="n">domain</span> <span class="o">=</span> <span class="n">openapiEndpointInfo</span><span class="o">.</span><span class="na">getHost</span><span class="o">().</span><span class="na">split</span><span class="o">(</span><span class="s">"://"</span><span class="o">);</span>
            <span class="nc">String</span><span class="o">[]</span> <span class="n">hostAndPort</span> <span class="o">=</span> <span class="n">domain</span><span class="o">[</span><span class="mi">1</span><span class="o">].</span><span class="na">split</span><span class="o">(</span><span class="s">":"</span><span class="o">);</span>
            <span class="nc">String</span> <span class="n">hostname</span> <span class="o">=</span> <span class="n">domain</span><span class="o">[</span><span class="mi">1</span><span class="o">];</span>
            <span class="nc">String</span> <span class="n">scheme</span> <span class="o">=</span> <span class="n">domain</span><span class="o">[</span><span class="mi">0</span><span class="o">];</span>
            <span class="kt">int</span> <span class="n">port</span> <span class="o">=</span> <span class="o">(</span><span class="n">scheme</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">"https"</span><span class="o">)</span> <span class="o">?</span> <span class="mi">443</span> <span class="o">:</span> <span class="mi">80</span><span class="o">);</span>
            <span class="k">if</span><span class="o">(</span><span class="n">hostAndPort</span><span class="o">.</span><span class="na">length</span><span class="o">&gt;</span><span class="mi">1</span><span class="o">){</span>
                <span class="n">hostname</span> <span class="o">=</span> <span class="n">hostAndPort</span><span class="o">[</span><span class="mi">0</span><span class="o">];</span>
                <span class="n">port</span> <span class="o">=</span> <span class="nc">Integer</span><span class="o">.</span><span class="na">parseInt</span><span class="o">(</span><span class="n">hostAndPort</span><span class="o">[</span><span class="mi">1</span><span class="o">]);</span>
            <span class="o">}</span>

            <span class="nc">HttpHost</span> <span class="n">host</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HttpHost</span><span class="o">(</span><span class="n">hostname</span><span class="o">,</span> <span class="n">port</span><span class="o">,</span> <span class="n">scheme</span><span class="o">);</span>

            <span class="nc">RestTemplate</span> <span class="n">restTemplate</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">RestTemplate</span><span class="o">();</span>
            <span class="nc">HttpRequestFactoryAuthentication</span> <span class="n">requestFactory</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HttpRequestFactoryAuthentication</span><span class="o">();</span>
            <span class="n">requestFactory</span><span class="o">.</span><span class="na">setCredentials</span><span class="o">(</span><span class="n">host</span><span class="o">,</span> <span class="n">openapiEndpointInfo</span><span class="o">.</span><span class="na">getAuthType</span><span class="o">(),</span> <span class="n">openapiEndpointInfo</span><span class="o">.</span><span class="na">getUsername</span><span class="o">(),</span> <span class="n">openapiEndpointInfo</span><span class="o">.</span><span class="na">getPassword</span><span class="o">());</span>
            <span class="n">restTemplate</span><span class="o">.</span><span class="na">setRequestFactory</span><span class="o">(</span><span class="n">requestFactory</span><span class="o">);</span>

            <span class="nc">HttpHeaders</span> <span class="n">headers</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HttpHeaders</span><span class="o">();</span>
            <span class="n">headers</span><span class="o">.</span><span class="na">setContentType</span><span class="o">(</span><span class="nc">MediaType</span><span class="o">.</span><span class="na">APPLICATION_JSON</span><span class="o">);</span>

            <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;</span> <span class="n">mapData</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HashMap</span><span class="o">&lt;&gt;();</span>
            <span class="n">mapData</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"details"</span><span class="o">,</span> <span class="n">pamStatus</span><span class="o">.</span><span class="na">getDetails</span><span class="o">());</span>
            <span class="n">mapData</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"workId"</span><span class="o">,</span> <span class="n">pamStatus</span><span class="o">.</span><span class="na">getWorkId</span><span class="o">());</span>
            <span class="n">mapData</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"taskId"</span><span class="o">,</span> <span class="n">pamStatus</span><span class="o">.</span><span class="na">getTaskId</span><span class="o">());</span>
            <span class="n">mapData</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"progressStatus"</span><span class="o">,</span> <span class="n">pamStatus</span><span class="o">.</span><span class="na">getProgressStatus</span><span class="o">());</span>
            <span class="n">mapData</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"updatedDate"</span><span class="o">,</span> <span class="o">(</span><span class="n">pamStatus</span><span class="o">.</span><span class="na">getUpdatedDate</span><span class="o">()</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">?</span> <span class="n">pamStatus</span><span class="o">.</span><span class="na">getUpdatedDate</span><span class="o">().</span><span class="na">atZone</span><span class="o">(</span><span class="nc">ZoneId</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="s">"GMT"</span><span class="o">)).</span><span class="na">format</span><span class="o">(</span><span class="nc">DateTimeFormatter</span><span class="o">.</span><span class="na">ISO_DATE_TIME</span><span class="o">)</span> <span class="o">:</span> <span class="kc">null</span><span class="o">));</span>
            <span class="nc">ObjectWriter</span> <span class="n">ow</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ObjectMapper</span><span class="o">().</span><span class="na">writer</span><span class="o">().</span><span class="na">withDefaultPrettyPrinter</span><span class="o">();</span>
            <span class="nc">String</span> <span class="n">json</span> <span class="o">=</span> <span class="n">ow</span><span class="o">.</span><span class="na">writeValueAsString</span><span class="o">(</span><span class="n">mapData</span><span class="o">);</span>

            <span class="nc">HttpEntity</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">entity</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HttpEntity</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;(</span><span class="n">json</span><span class="o">,</span> <span class="n">headers</span><span class="o">);</span>
            <span class="n">restTemplate</span><span class="o">.</span><span class="na">getMessageConverters</span><span class="o">().</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="nc">MappingJackson2HttpMessageConverter</span><span class="o">());</span>
            <span class="nc">String</span> <span class="n">response</span> <span class="o">=</span> <span class="n">restTemplate</span><span class="o">.</span><span class="na">postForObject</span><span class="o">(</span><span class="n">pamStatus</span><span class="o">.</span><span class="na">getEndPoint</span><span class="o">(),</span> <span class="n">entity</span><span class="o">,</span> <span class="nc">String</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

            <span class="k">return</span> <span class="k">new</span> <span class="nf">Response</span><span class="o">(</span><span class="nc">HttpStatus</span><span class="o">.</span><span class="na">OK</span><span class="o">.</span><span class="na">getReasonPhrase</span><span class="o">(),</span> <span class="nc">HttpStatus</span><span class="o">.</span><span class="na">OK</span><span class="o">,</span> <span class="n">response</span><span class="o">);</span>
        <span class="o">}</span><span class="k">catch</span><span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">){</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
            <span class="k">return</span> <span class="k">new</span> <span class="nf">Response</span><span class="o">(</span><span class="s">"ENDPOINT ERROR :"</span><span class="o">+</span><span class="n">e</span><span class="o">.</span><span class="na">getMessage</span><span class="o">(),</span> <span class="nc">HttpStatus</span><span class="o">.</span><span class="na">INTERNAL_SERVER_ERROR</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
        <span class="o">}</span>

    <span class="o">}</span>
</code></pre></div></div>

<p>ì°¸ê³ í•œ ì¶œì²˜ : 
<a href="https://github.com/eugenp/tutorials/tree/master/spring-security-modules/spring-security-web-digest-auth">spring-security-modules/spring-security-web-digest-auth</a>
<a href="https://attacomsian.com/blog/resttemplate-basic-authentication">RestTemplate Basic Authentication Example</a>
<a href="https://github.com/kytkemo/preemptive-authentication-rest-template/blob/master/src/main/java/com/kytkemo/preemptiveauthenticationresttemplate/web/client/PreemptiveAuthenticationRestTemplate.java">preemptive-authentication-rest-template</a>
<a href="https://www.techgeeknext.com/spring-boot-security/digest_authentication_web_security">Spring Boot Security Tutorial_ Digest Authentication</a>
<a href="https://javadeveloperzone.com/spring-boot/spring-security-digest-authentication-example/">Spring security digest authentication example</a></p>
:ET