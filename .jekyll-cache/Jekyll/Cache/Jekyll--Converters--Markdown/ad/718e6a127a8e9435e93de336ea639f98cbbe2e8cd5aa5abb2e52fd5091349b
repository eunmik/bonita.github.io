I"i <h1 id="oauth2-resource-server-ë€">OAUTH2 Resource Server ë€?</h1>

<p>Spring Securityì—ì„œ JWT Token ì„¤ì •ì„ í•˜ê³  ìˆë‹¤. ê¸°ë³¸ê¸°ê°€ ë§ì´ ë¶€ì¡±í•´ì„œ ì„¤ì •ì„ í•˜ë©´ì„œ ì—¬ê¸°ì €ê¸° ë¸”ë¡œê·¸/ì»¬ëŸ¼/ê³µí™ˆì„ ì°¸ê³ í•˜ë©° í•˜ê³  ìˆëŠ”ë° (ì •í™•íˆ ë‚´ê°€ ë­í•˜ê³  ìˆëŠ”ì§€ ì´í•´ê°€ 100%ê°€ ë˜ì§€ ì•Šì•„ì„œ ìŠ¬í‘¸ë‹¤ğŸ˜¢) ê·¸ê²Œ ë¬¸ì œì¸ê²ƒ ê°™ë‹¤. Authorization Serverë§Œ ì ìš© í–ˆì„ ë•ŒëŠ” JWT Tokenì— ì•„ë¬´ ë¬¸ì œê°€ ì—†ì—ˆëŠ”ë° Resource Serverë¥¼ ì ìš©í•˜ëŠ”ë° ìê¾¸ headerì— ìˆëŠ” JWT Tokenì„ invalid access tokenì´ë¼ê³  return í•œë‹¤. (Whyranoâ€¦.!!!)</p>

<p>OAUTH2, Spring Securityë„ ì´í•´ë¥¼ ë•ê¸°ìœ„í•´ ë‚˜ì¤‘ì— ê¼­ ë‹¤ì‹œ ì •ë¦¬í•´ ì˜¬ë ¤ë´ì•¼ê² ë‹¤. 
ì˜¤ëŠ˜ì€ ìš°ì„  Resource Serverê°€ ë­ê¸¸ë˜ ë‚  ì´ë ‡ê²Œ í˜ë“¤ê²Œ í•˜ëŠ”ì§€ ì•Œì•„ë³´ê¸°ë¡œ í–ˆë‹¤!</p>

<h2 id="resource-server-ë€">Resource Server ë€?</h2>

<p>Resource ServerëŠ” OAUTH 2.0ì—ì„œ ì‚¬ìš©í•˜ëŠ” ìš©ì–´ì´ë‹¤. Resource ServerëŠ” ì–´í”Œë¦¬ì¼€ì´ì…˜ì´ access tokenì„ ì–»ê³  ë‚œ í›„ì— ì¸ì¦ëœ ìš”ì²­ì„ ì²˜ë¦¬í•œë‹¤. ì¦‰, ì‚¬ìš©ìì—ê²Œ ë¦¬ì†ŒìŠ¤ ì‚¬ìš©ì„ í—ˆë½í•˜ê¸° ì „ì— í† í°ì„ ì¦ëª…í•˜ëŠ” ê²ƒì´ë‹¤. í° ê·œëª¨ ê°™ì€ ê²½ìš°ì—ëŠ” ì—¬ëŸ¬ê°œì˜ resource serverë¥¼ ê°€ì§€ê³  ìˆì„ ìˆ˜ë„ ìˆë‹¤. ì˜ˆë¥¼ ë“¤ì–´, êµ¬ê¸€ ì„œë¹„ìŠ¤ ê°™ì€ ê²½ìš°ì—ëŠ” Google Cloud Platform, Google Maps, Google Drive, Youtube, ë“± 20ê°œì •ë„ì˜ resource serverë¥¼ ê°€ì§€ê³  ìˆë‹¤. ê° ê°ì˜ resource serverë“¤ì€ ë‚˜ëˆ ì ¸ ìˆì§€ë§Œ ëª¨ë“œ ê°™ì€ authorization serverë¥¼ ì‚¬ìš©í•˜ê³  ìˆë‹¤.</p>

<p>ì‘ì€ ê·œëª¨ì¸ ê²½ìš° ë³´í¸ì ìœ¼ë¡œ ì˜¤ì§ í•˜ë‚˜ì˜ resource serverë¥¼ ê°€ì§€ê³  ìˆê³  ì¢…ì¢… authorization serverì™€ ê°™ì€ baseì—ì„œ ì„¤ì¹˜ë˜ê³¤ í•œë‹¤.</p>

<p>Resource serverëŠ” access tokenê°€ ìˆëŠ” HTTP Authorization headerë¥¼ ê°€ì§€ê³  ìˆëŠ” ì–´í”Œë¦¬ì¼€ì´ì…˜ìœ¼ë¡œë¶€í„° ìš”ì²­ì„ ë°›ê²Œ ë  ê²ƒì´ë‹¤. Resource serverëŠ” ìš”ì²­ì„ ì§„í–‰ ì‹œí‚¬ì§€ ë§ì§€ ê²°ì •ì„ ìœ„í•´ access  tokenì„ ì¦ëª…í•´ì•¼ í•  í•„ìš”ê°€ ìˆë‹¤. tokenì€ Autorization serverì˜í•´ ë°œí–‰ë˜ì—ˆë‹¤.</p>

<p>í† í°ì˜ ì¦ëª…ì€ ì•„ë˜ ë‚˜ì—´ëœ ëª‡ê°€ì§€ë¡œ ê²°ì •ì´ ëœë‹¤.</p>

<ul>
  <li>ì„¤ì •ëœ autorrizaiton serverì—ì„œ ë°œí–‰ëœ í† í°ì¸ê°€?</li>
  <li>í† í°ì´ ì•„ì§ ìœ íš¨í•œê°€?</li>
  <li>ì‚¬ìš©í•˜ê³ ì í•˜ëŠ” resource serverì¸ê°€?</li>
  <li>ìš”ì²­ëœ ë¦¬ì†ŒìŠ¤ì— ì ‘ê·¼í•  ìˆ˜ ìˆëŠ” ì¸ì¦ì„ í† í°ì´ ê°€ì§€ê³  ìˆëŠ”ê°€?</li>
</ul>

<p>Resource ServerëŠ” access tokenê³¼ ì—°ê´€ëœ scopesì„ ì•Œ í•„ìš”ê°€ ìˆë‹¤. ì„œë²„ëŠ” ë§Œì•½ access tokenì— ìˆëŠ” scope listì— ìš”ì²­ì„ ìˆ˜í–‰í•˜ê¸°ìœ„í•´ í•„ìš”í•œ scopeì´ í¬í•¨ë˜ì–´ ìˆì§€ ì•ŠëŠ”ë‹¤ë©´ ìš”ì²­ì„ ê±°ë¶€í•´ì•¼ í•œë‹¤.</p>

<p>ë§Œì•½ access tokenì´ ìš”ì²­ëœ resourceì˜ ì ‘ê·¼ í—Œìš©ì´ ë˜ì§€ ì•Šê±°ë‚˜ ìš”ì²­ì— access tokenì´ ì¡´ì¬í•˜ì§€ ì•ŠëŠ”ë‹¤ë©´ ì„œë²„ëŠ” 401 Responseë¥¼ ë¦¬í„´í•´ì•¼í•˜ê³  WWW-Authentiate í—¤ë”ë¥¼ responseì— í¬í•¨ ì‹œì¼œì•¼ í•œë‹¤.</p>

<p><img src="../assets/img/210317-headers-401.png" /></p>

<p>WWW-Authenticate í—¤ë”ëŠ” ìµœì†Œ í•„ìš”í•œ bearer tokenì„ ë‚˜íƒ€ë‚´ëŠ” Bearer ê¸€ìë¥¼ í¬í•¨í•˜ê³  ìˆê³  ì¶”ê°€ì ì¸ ì •ë³´ë¥¼ ê°€ì§€ê³  ìˆì¼ ìˆ˜ë„ ìˆë‹¤.</p>

<p><img src="../assets/img/210317-diagram.png" /></p>

<p>ìœ„ ë‹¤ì´ì–´ê·¸ë¨ì—ì„œ step 8ì„ ë³´ë©´ í´ë¼ì´ì–¸íŠ¸ ì–´í”Œë¦¬ì¼€ì´ì…˜ì´ resourceì— ì ‘ê·¼í•˜ê¸° ìœ„í•´ resource ã„´server APIë¥¼ í˜¸ì¶œí• ë•Œ, ìš°ì„  authorization serverì— ê°€ì„œ ìš”ì²­ì— ìˆëŠ” Authorization í—¤ë”ë¥¼ ì¦ëª…í•œë‹¤ ê·¸ë¦¬ê³  ë‚˜ì„œ í´ë¼ì´ì–¸íŠ¸ì—ê²Œ respone í•œë‹¤.</p>

<p>ì°¸ê³ í•œ ìë£Œ ì¶œì²˜ : <a href="https://www.oauth.com/oauth2-servers/the-resource-server/">https://www.oauth.com/oauth2-servers/the-resource-server/</a>, <a href="https://www.baeldung.com/spring-security-oauth-resource-server">https://www.baeldung.com/spring-security-oauth-resource-server</a></p>

<h2 id="resource-server-config">Resource Server Config</h2>

<p>@EnableResourceServerë¥¼ ì„ ì–¸í•˜ì—¬ Resource Serverì„ì„ ì•Œë ¤ì£¼ì–´ì•¼ í•œë‹¤. 
ì´ Configì—ì„œëŠ” ê° ë¦¬ì†ŒìŠ¤ì— ëŒ€í•œ ì ‘ê·¼ ê¶Œí•œì„ ì„¤ì •í•´ ì¤„ ìˆ˜ ìˆë‹¤. 
auto configuration(jar dependencyë¥¼ ê¸°ì¤€ìœ¼ë¡œ Spring ì–´í”Œë¦¬ì¼€ì´ì…˜ì„ ìë™ìœ¼ë¡œ ì„¤ì •ì„ í•´ì£¼ëŠ” ê²ƒ) ì„ ì‚¬ìš©ê³¼ jwtë¥¼ ì‚¬ìš©í•˜ê¸°ìœ„í•´ libraryê°€ í•„ìš”í•˜ë‹¤. 
(2.4.0 RELEASE ë¶€í„°ëŠ” @EnableAutorizationServer, @EnableReosurceServer ì–´ë…¸í…Œì´ì…˜ì´ Deprecatedê°€ ë˜ì–´ìˆëŠ”ë° ì–´ë–»ê²Œ Migration í•´ì•¼ë˜ëŠ”ì§€ ì˜ ëª¨ë¥´ê² ë‹¤ ğŸ˜¥)</p>

<h3 id="pomxml">pom.xml</h3>

<figure class="highlight"><pre><code class="language-xml" data-lang="xml"><span class="nt">&lt;dependency&gt;</span>
			<span class="nt">&lt;groupId&gt;</span>org.springframework.security.oauth<span class="nt">&lt;/groupId&gt;</span>
			<span class="nt">&lt;artifactId&gt;</span>spring-security-oauth2<span class="nt">&lt;/artifactId&gt;</span>
			<span class="nt">&lt;version&gt;</span>2.3.8.RELEASE<span class="nt">&lt;/version&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
<span class="nt">&lt;dependency&gt;</span>
			<span class="nt">&lt;groupId&gt;</span>org.springframework.security<span class="nt">&lt;/groupId&gt;</span>
			<span class="nt">&lt;artifactId&gt;</span>spring-security-jwt<span class="nt">&lt;/artifactId&gt;</span>
			<span class="nt">&lt;version&gt;</span>1.1.1.RELEASE<span class="nt">&lt;/version&gt;</span>
<span class="nt">&lt;/dependency&gt;</span></code></pre></figure>

<p>ìµœì†Œí•œì˜ resource server configurationì€</p>

<ul>
  <li>dependencyê°€ í¬í•¨ëœë‹¤</li>
  <li>@EnableResourceServer ì–´ë…¸í…Œì´ì…˜ì´ í¬í•¨ëœë‹¤.</li>
  <li>beare í† í°ì„ ì¸ì¦í•˜ê¸°ìœ„í•œ strategyê°€ ëª…ì‹œëœë‹¤.</li>
</ul>

<p>ì•„ë˜ëŠ” Resource Server Configì˜ ì˜ˆì œì´ë‹¤.</p>

<h3 id="reseourceserverconfigjava">ReseourceServerConfig.java</h3>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="nd">@Configuration</span>
<span class="nd">@EnableResourceServer</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ResourceServerConfig</span> <span class="kd">extends</span> <span class="nc">ResourceServerConfigurerAdapter</span> <span class="o">{</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">configure</span><span class="o">(</span><span class="nc">ResourceServerSecurityConfigurer</span> <span class="n">resources</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
        <span class="n">resources</span><span class="o">.</span><span class="na">tokenStore</span><span class="o">(</span><span class="n">tokenStore</span><span class="o">()).</span><span class="na">resourceId</span><span class="o">(</span><span class="s">"SPRING_BOOT"</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">configure</span><span class="o">(</span><span class="nc">HttpSecurity</span> <span class="n">http</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>

        <span class="n">http</span>
                <span class="o">.</span><span class="na">headers</span><span class="o">().</span><span class="na">frameOptions</span><span class="o">().</span><span class="na">disable</span><span class="o">().</span><span class="na">and</span><span class="o">()</span>
                <span class="o">.</span><span class="na">authorizeRequests</span><span class="o">()</span>
                <span class="o">.</span><span class="na">antMatchers</span><span class="o">(</span><span class="s">"/"</span><span class="o">).</span><span class="na">permitAll</span><span class="o">()</span>
                <span class="o">.</span><span class="na">anyRequest</span><span class="o">().</span><span class="na">authenticated</span><span class="o">()</span>
        <span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre></figure>

<p>ì°¸ê³  í•œ ìë£Œ ì¶œì²˜ : <a href="https://docs.spring.io/spring-security-oauth2-boot/docs/current/reference/html5/#boot-features-security-oauth2-resource-server">https://docs.spring.io/spring-security-oauth2-boot/docs/current/reference/html5/#boot-features-security-oauth2-resource-server</a></p>
:ET