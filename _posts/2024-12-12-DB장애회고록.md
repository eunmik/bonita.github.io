---
layout: post
title: "DB 장애 회고록"
date: 2024-12-12
categories: ["memoir"]
tags: ["memoir"]
comments: true
---

**2024/12/12** 

내가 담당한 서비스에 큰 장애가 났다 
우리팀은 출근하자마자 각자 서비스의 상태 모니터링 결과를
메일로 보고를 하고 있어서 오늘도 나는 평소처럼 모니터링 쿼리를 실행시켰다 

8시 4분 텔레그램으로 무섭게 메시지가 날라왔다 
난가? 내가 잘못했나? 내가 DB에 부하를 준것일까? 

일단 팀장님에게 먼저 말씀을 드리고 
팀장님은 바로 시스템운영팀으로 달려가셨다 

올해만 (내가 팀을 옮긴 이후) 담당 서비스의 DB관련 장애가 벌써 3번째이다
소잃고 외양간 고치는 느낌으로 장애가 난 후에 
조금씩 조치를 취하며 변화를 주었지만 또 빅서프라이즈~ 

저번에 장애가 발생했을 때는 
인덱스 설계가 잘못되어있는 테이블에 너무 많은 양의 데이터가 있었고 
그 테이블은 심지어 자주 INSERT/SELECT가 되는 테이블이었다 

그래서 팀장님이 항상 리인덱싱 조치를 꼭 해야하는 테이블이라고 
말씀하셨는데 결국 DB가 DOWN되는 상황이 닥치고 나서야 
리인덱싱 작업이 진행되었다.. 

이번에는 정확한 원인은 아직 미궁이지만 
확실한건 장애가 발생하기 직전 (DB엔진이 내려가기 직전)에 
남겨진 로그에는 내가 실행한 모니터링 쿼리였다 

원래 모니터링 쿼리는 일주일 단위로 데이터를 조회하고 있었는데 
“그 쿼리”는 저번달부터 시작한 다른 연동 서비스 관련 통계 쿼리로 
일주일 단위로 하면 데이터가 10건 정도밖에 나오지 않아서 

내가 임의로 결정해서 오픈 시점인 11월 05일부터의 데이터를 전부 조회했다 
“그 쿼리”가 DB엔진이 DOWN되는 원인의 100%는 아니겠지만 
어느정도 지분을 차지하고 있지는 않았을까 싶다. 

장애상황이 발생할 때 
내가 할 수 있는 것이라고는 
핀포인트와 로그를 보며 장애상황을 모니터링 하는 것이다 
모니터링으로 장애를 해결할 수 는 없다 

DB관련 에러가 계속 발생했기 때문에 DB와 연동이 되어있는 
서버 데몬들을 전부 SHUTDOWN을 하였고 
SHUTDOWN 하는 동안 팀장님은 에러페이지를 순식간에 만들어서 

사용자에게 웹뷰를 제공하는 WEB WAS SERVER에 배포를 했다 
점심시간에는 내가 할수있는 게 없어서 팀장님이 
장애대응을 위해 점심도 안드시고 대기를 하셨고 나는 붕어빵 사러 갔다 
붕어빵으로 힘을 복돋아 드리려 했지만 그렇게 하지 못한듯.. 

장애는 3시쯤에 해소가 되어 서비스 안정화 모니터링을 계속하였다 
장애는 해소가 되었지만 이제 후폭풍을 처리해야겠지.. 

DB와 서버가 다운되어있던 동안 
출석체크 이벤트, 오퍼월 적립, 기프트샵 구매, 패스머니 가입 및 해지 등 
수많은 요청들이 거절 되었을 것이고 금전적인 피해는 내가 생각하는 거 이상이겠지? 

장애 원인 
- 1차 : 알수 없음..
- 2차: 인적장애, DB 복구 작업을 하는 도중 동기화를 끊지 않고 작업을 하는 바람에 한쪽 DB를 복구하기 위해 리셋하는 과정에서 다 날라감??
    - 백업 해놓은 DB로 복구작업을 진행
    - 그러면 DB가 날라간 시점과 백업이 DB가 백업된 시간 사이에 발생한 트랜잭션은 어쩔? - bin log가 해결해준다~

아쉬웠던 점: 
- 장애가 나면 내가할 수 있는게 크게 없다
- 시스템운영팀에 의존하게 된다
- 개발팀으로서 장애 상황에 효율적으로 대응할 수 있는게 무엇이 있을까?
- 디비 장애가 났을 때 에러코드를 추가한 작업을 오늘 배포할 예정이었는데.. 진작에 할걸..

개선해야할 점: 
- 모니터링 쿼리를 튜닝해야겠다, 모니터링 쿼리를 DBA분께 리뷰를 요청해볼까?
- 조치를 한다고 해도 장애가 100%안 난다고 장담할 수 없기 때문에
    - 후보정을 위한 로그를 잘 쌓자.

내일 물어볼 것: 
- DBA 휴먼에러가 정확히 뭔지 여쭤보기
- 어떻게 해결이 되었는지 여쭤보기
- 개발팀으로서 장애 상황에 효율적으로 대응할 수 있는게 무엇이 있을까?

이것은 회고록인가 일기인가 반성문인가~ 